<!DOCTYPE html>
<html lang="pt-BR">
<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Preenchimento de Receita</title>

<!-- PDF-LIB -->
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<style>
body{margin:0;font-family:Arial,sans-serif;background:#f4f4f4}
.container{max-width:750px;margin:auto;padding:16px}
h1{text-align:center;margin-bottom:20px}
.campo{margin-bottom:16px}
label{font-weight:bold;display:block;margin-bottom:6px}

input,select,textarea{
  width:100%;
  padding:12px;
  font-size:16px;
  box-sizing:border-box
}

button{
  padding:12px;
  font-size:16px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  background:#27ae60;
  color:#fff;
}

.medicacao-box{background:#fff;border:1px solid #ccc;padding:10px;margin-bottom:10px}
.medicacao-linha{display:flex;gap:6px;align-items:center}
.num{width:32px;font-weight:bold;text-align:center}
.btn-apagar{background:#e74c3c}
.btn-lupa{background:#34495e}
.btn-add{background:#2980b9;margin-top:8px}

/* DATA */
.data-box{display:flex;gap:10px}
.data-box input{text-align:center}

/* SIDEBAR */
.sidebar{
  position:fixed;
  inset:0;
  background:#fff;
  z-index:999;
  display:none;
  flex-direction:column;
}

.sidebar-topo{
  background:#e74c3c;
  padding:6px 10px;
}
.sidebar-topo button{
  background:#c0392b;
  padding:6px 10px;
  font-size:14px;
}

.sidebar-busca{
  padding:8px;
}
.sidebar-busca input{
  padding:6px 8px;
  font-size:13px;
  height:32px;
}

.sidebar-lista{
  flex:1;
  overflow-y:auto;
  padding:6px 8px;
}

.categoria{
  font-weight:bold;
  margin:10px 0 4px;
  font-size:14px;
}

.item{
  padding:6px 4px;
  border-bottom:1px dashed #ccc;
  font-size:14px;
  line-height:1.3;
  cursor:pointer;
}
.item:hover{background:#f0f0f0}
/* ===== CATEGORIAS EM ABAS (ACCORDION) ===== */
.categoria-aba{
  background:#eee;
  padding:8px;
  margin-top:8px;
  border-radius:6px;
  font-weight:bold;
  font-size:14px;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.categoria-aba:hover{
  background:#e0e0e0;
}

.categoria-itens{
  display:none;
  padding-left:6px;
}

.categoria-itens.aberta{
  display:block;
}

/* Mostrar bot√£o Editar apenas no hover da categoria */
.categoria-aba button{
  display:none;
}

.categoria-aba:hover button{
  display:inline-block;
}
</style>

</head>

<body>
<!-- LOGIN -->
<div id="loginBox" style="max-width:400px;margin:60px auto;padding:20px;background:#fff;border-radius:8px">
  <h2 style="text-align:center">Login</h2>

  <div class="campo">
    <label>Email</label>
    <input type="email" id="loginEmail">
  </div>

  <div class="campo">
    <label>Senha</label>
    <input type="password" id="loginSenha">
  </div>

  <button onclick="login()">Entrar</button>
</div>

<div class="container" id="app" style="display:none">
<h1>Receita M√©dica</h1>

<div class="campo">
<label>Selecionar PDF base</label>
<input type="file" id="pdfBase" accept="application/pdf">
</div>

<div class="campo">
<label>NOME DO PACIENTE</label>
<input id="nomePaciente" oninput="this.value=this.value.toUpperCase()">
</div>

<div class="campo">
<label>USO</label>
<select id="uso">
<option value="">Selecione</option>
<option>USO ORAL</option>
<option>USO T√ìPICO</option>
</select>
</div>

<div class="campo">
<label>MEDICA√á√ïES</label>
<div id="listaMedicacoes"></div>
<button type="button" class="btn-add" onclick="adicionarMedicacao()">‚ûï Adicionar Medica√ß√£o</button>
</div>

<div class="campo">
<label>DATA</label>
<div class="data-box">
<input id="dataDia" placeholder="DD" maxlength="2">
<input id="dataMes" placeholder="MM" maxlength="2">
<input id="dataAno" placeholder="AAAA" maxlength="4">
</div>
</div>

<button type="button" onclick="gerarPDF()">üìÑ Gerar PDF</button>

<button type="button"
        style="background:#e67e22;margin-top:10px"
        onclick="limparDados()">
üßπ Limpar dados
</button>

</div>

<!-- SIDEBAR -->
<div id="sidebar" class="sidebar">
  <div class="sidebar-topo">
    <button type="button" onclick="fecharSidebar()">Fechar</button>
  </div>
  <div class="sidebar-busca">
    <input placeholder="Buscar..." oninput="renderizarLista(this.value)">
  </div>
  <div style="padding:8px;border-bottom:1px solid #ddd">
  <button type="button"
    style="background:#2980b9;width:100%;font-size:14px"
    onclick="abrirFormularioManual()">
    ‚ûï Adicionar medica√ß√£o manualmente
  </button>
</div>

<div id="formManual" style="display:none;padding:8px;border-bottom:1px solid #ddd">
  <select id="categoriaSelect" onchange="verificarNovaCategoria()"
    style="margin-bottom:6px">
  </select>

  <input id="novaCategoria" placeholder="Nova categoria"
    style="display:none;margin-bottom:6px">

<input id="novaMedicacao"
       placeholder="Nome da medica√ß√£o"
       style="margin-bottom:6px"
       oninput="this.value = cap(this.value)">

<textarea id="novoUso"
          placeholder="Modo de uso"
          oninput="this.value = cap(this.value)"></textarea>

  <button style="margin-top:6px;width:100%"
    onclick="salvarMedicacaoManual()">
    Salvar medica√ß√£o
  </button>
</div>

<div id="listaSidebar" class="sidebar-lista"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("app").style.display = "none";
  document.getElementById("loginBox").style.display = "block";
});
const LIMITE = 8;
let campoAtual = null;

/* Primeira letra mai√∫scula sem travar CAPS */
function cap(t){
 if(!t) return "";
 return t[0].toUpperCase() + t.slice(1);
}

/* BANCO DE MEDICA√á√ïES */
const banco=[];
function medicacaoExiste(nome, uso){
  return banco.some(m =>
    m.n.toLowerCase().trim() === nome.toLowerCase().trim() &&
    m.u.toLowerCase().trim() === uso.toLowerCase().trim()
  );
}

/* üî• PASSO 4 ‚Äî CARREGAR MEDICA√á√ïES DO FIREBASE */
async function carregarMedicacoesFirebase(){
  const snapshot = await db
    .collection("medicacoes")
    .orderBy("criadoEm")
    .get();

  snapshot.forEach(doc=>{
    const d = doc.data();

    if(!medicacaoExiste(d.nome, d.uso)){
      banco.push({
        id: doc.id,
        c: d.categoria || "‚≠ê Medica√ß√µes rec√©m adicionadas",
        n: d.nome,
        u: d.uso
      });
    }
  });
}

async function salvarMedicacaoFirebase(nome, uso, categoria){
  const user = auth.currentUser;
  if(!user) return null;

  const docRef = await db.collection("medicacoes").add({
    nome: nome,
    uso: uso,
    categoria: categoria, // ‚úÖ agora salva a categoria correta
    criadoEm: firebase.firestore.FieldValue.serverTimestamp(),
    criadoPor: user.email
  });

  return docRef.id;
}

/* MEDICA√á√ïES */
function adicionarMedicacao(){
 if(document.querySelectorAll(".medicacao-box").length>=LIMITE)
  return alert("Limite m√°ximo de 8 medica√ß√µes.");

 const d=document.createElement("div");
 d.className="medicacao-box";
 d.innerHTML=`
 <div class="medicacao-linha">
  <div class="num"></div>
  <input class="med1" placeholder="Medica√ß√£o" oninput="this.value=cap(this.value)">
  <button type="button" class="btn-lupa" onclick="abrirSidebar(this)">üîç</button>
  <button type="button" class="btn-apagar" onclick="this.closest('.medicacao-box').remove();numerar()">APAGAR</button>
 </div>
 <textarea class="med2" placeholder="Uso" oninput="this.value=cap(this.value)"></textarea>`;
 document.getElementById("listaMedicacoes").appendChild(d);
 numerar();
}

function numerar(){
 document.querySelectorAll(".num").forEach((e,i)=>e.textContent=(i+1)+")");
}

/* SIDEBAR */
function abrirSidebar(btn){
 campoAtual=btn.closest(".medicacao-box");
 document.getElementById("sidebar").style.display="flex";
 renderizarLista();
}
function fecharSidebar(){
 document.getElementById("sidebar").style.display="none";
}

/* üî• FORMUL√ÅRIO MANUAL DA SIDEBAR */

function abrirFormularioManual(){
  const f = document.getElementById("formManual");
  f.style.display = f.style.display === "none" ? "block" : "none";
  carregarCategorias();
}

function carregarCategorias(){
  const select = document.getElementById("categoriaSelect");
  const inputNova = document.getElementById("novaCategoria");

  select.innerHTML = "";

  const categorias = [...new Set(banco.map(m => m.c))];

  categorias.forEach(c=>{
    const o = document.createElement("option");
    o.value = c;
    o.textContent = c;
    select.appendChild(o);
  });

  // Op√ß√£o de nova categoria
  const nova = document.createElement("option");
  nova.value = "__nova__";
  nova.textContent = "‚ûï Nova categoria";
  select.appendChild(nova);

  // üî• SE N√ÉO EXISTIR NENHUMA CATEGORIA
  if(categorias.length === 0){
    select.value = "__nova__";
    inputNova.style.display = "block";
  }else{
    inputNova.style.display = "none";
  }
}

function verificarNovaCategoria(){
  const v = document.getElementById("categoriaSelect").value;
  document.getElementById("novaCategoria").style.display =
    v === "__nova__" ? "block" : "none";
}

async function salvarMedicacaoManual(){
  const catSelect = document.getElementById("categoriaSelect").value;
  const novaCat   = document.getElementById("novaCategoria").value.trim();
  const nome      = document.getElementById("novaMedicacao").value.trim();
  const uso       = document.getElementById("novoUso").value.trim();

  if(!nome || !uso){
    alert("Preencha a medica√ß√£o e o uso.");
    return;
  }

  const categoria = catSelect === "__nova__" ? novaCat : catSelect;

  if(!categoria){
    alert("Informe a categoria.");
    return;
  }

  if(medicacaoExiste(nome, uso)){
    alert("Essa medica√ß√£o j√° existe.");
    return;
  }

const id = await salvarMedicacaoFirebase(nome, uso, categoria);

  if(id){
    banco.push({
      id: id,
      c: categoria,
      n: nome,
      u: uso
    });

renderizarLista();

// üî• LIMPAR CAMPOS PARA PR√ìXIMA MEDICA√á√ÉO
document.getElementById("novaMedicacao").value = "";
document.getElementById("novoUso").value = "";

const selectCat = document.getElementById("categoriaSelect");
const inputNova = document.getElementById("novaCategoria");

// Se estava criando nova categoria
if(selectCat.value === "__nova__"){
  inputNova.value = "";
  inputNova.focus();
}else{
  // mant√©m categoria e foca no nome da medica√ß√£o
  document.getElementById("novaMedicacao").focus();
}

  }
}
 async function mudarCategoria(index, novaCategoria){
  const m = banco[index];
  if(!m || !novaCategoria) return;

  m.c = novaCategoria;

  if(m.id){
    await db.collection("medicacoes").doc(m.id).update({
      categoria: novaCategoria
    });
  }

  renderizarLista();
}

function renderizarLista(f=""){
  const lista = document.getElementById("listaSidebar");
  lista.innerHTML = "";

  // Agrupar por categoria
  const categorias = {};

  banco
    .filter(m => (m.n + m.u).toLowerCase().includes(f.toLowerCase()))
    .forEach(m => {
      if(!categorias[m.c]) categorias[m.c] = [];
      categorias[m.c].push(m);
    });


  Object.keys(categorias).forEach(cat => {
    // Cabe√ßalho da categoria (aba)
const cabecalho = document.createElement("div");
cabecalho.className = "categoria-aba";
cabecalho.innerHTML = `
  <span>${cat}</span>

  <div style="display:flex;gap:6px;align-items:center">
    <button
      style="font-size:11px;background:#3498db;padding:4px 8px"
      onclick="event.stopPropagation(); editarCategoria('${cat}')">
      Editar
    </button>
    <span>‚ñ∏</span>
  </div>
`;

    // Container dos itens
    const itensBox = document.createElement("div");
    itensBox.className = "categoria-itens";

categorias[cat].forEach(m => {
  const index = banco.indexOf(m);

  const i = document.createElement("div");
  i.className = "item";
  const categoriasUnicas = [...new Set(banco.map(x => x.c))];

i.innerHTML = `
  <strong>${m.n}</strong><br>
  ${m.u}

  <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">
<select style="font-size:12px"
  onchange="mudarCategoria(${index}, this.value)">
      ${categoriasUnicas.map(c =>
        `<option value="${c}" ${c===m.c?"selected":""}>${c}</option>`
      ).join("")}
    </select>

<button style="background:#2980b9;font-size:12px"
  onclick="editarMedicacao(${index})">‚úèÔ∏è Editar</button>

<button style="background:#e74c3c;font-size:12px"
  onclick="apagarMedicacao(${index})">üóëÔ∏è Apagar</button>

  </div>
`;

      i.onclick = (e) => {
        if(e.target.tagName === "BUTTON" || e.target.tagName === "SELECT") return;
        campoAtual.querySelector(".med1").value = m.n;
        campoAtual.querySelector(".med2").value = m.u;
        fecharSidebar();
      };

      itensBox.appendChild(i);
    });

    // Clique para expandir/recolher
    cabecalho.onclick = () => {
      const aberta = itensBox.classList.contains("aberta");

      document.querySelectorAll(".categoria-itens").forEach(c => c.classList.remove("aberta"));
      document.querySelectorAll(".categoria-aba span:last-child").forEach(s => s.textContent = "‚ñ∏");

      if(!aberta){
        itensBox.classList.add("aberta");
        cabecalho.querySelector("span:last-child").textContent = "‚ñæ";
      }
    };

    lista.appendChild(cabecalho);
    lista.appendChild(itensBox);
  });

}
async function editarMedicacao(index){
  const m = banco[index];
  if(!m) return;

  const novoNome = prompt("Editar medica√ß√£o:", m.n);
  if(!novoNome) return;

  const novoUso = prompt("Editar uso:", m.u);
  if(!novoUso) return;

  m.n = novoNome.trim();
  m.u = novoUso.trim();

  if(m.id){
    await db.collection("medicacoes").doc(m.id).update({
      nome: m.n,
      uso: m.u
    });
  }

  renderizarLista();
}

async function apagarMedicacao(index){
  const m = banco[index];
  if(!m) return;

  if(!confirm("Deseja realmente apagar esta medica√ß√£o?")) return;

  if(m.id){
    await db.collection("medicacoes").doc(m.id).delete();
  }

  banco.splice(index, 1);
  renderizarLista();
}

async function editarCategoria(nomeAtual){
  const novoNome = prompt("Editar nome da categoria:", nomeAtual);
  if(!novoNome || novoNome.trim() === nomeAtual) return;

  // Atualiza banco local
  banco.forEach(m => {
    if(m.c === nomeAtual){
      m.c = novoNome.trim();
    }
  });

  // Atualiza Firebase
  const snap = await db
    .collection("medicacoes")
    .where("categoria", "==", nomeAtual)
    .get();

  snap.forEach(doc=>{
    doc.ref.update({ categoria: novoNome.trim() });
  });

  renderizarLista();
}

/* GERAR PDF */
async function gerarPDF(){
 const file=document.getElementById("pdfBase").files[0];
 if(!file) return alert("Selecione o PDF base.");

 /* üî• SALVAR MEDICA√á√ïES NOVAS NO FIREBASE */
 for(const b of document.querySelectorAll(".medicacao-box")){
   const nome = b.querySelector(".med1").value.trim();
   const uso  = b.querySelector(".med2").value.trim();

   if(nome && uso && !medicacaoExiste(nome, uso)){
const id = await salvarMedicacaoFirebase(
  nome,
  uso,
  "‚≠ê Medica√ß√µes rec√©m adicionadas"
);

if(id){
  banco.push({
    id: id, 
    c: "‚≠ê Medica√ß√µes rec√©m adicionadas",
    n: nome,
    u: uso
      });
    }
  }
}

 const pdf=await PDFLib.PDFDocument.load(await file.arrayBuffer());
 const font=await pdf.embedFont(PDFLib.StandardFonts.TimesRoman);
 const p=pdf.getPages()[0];

 /* NOME */
 p.drawText(document.getElementById("nomePaciente").value,{x:188,y:1361.5,size:28,font});
 p.drawText(document.getElementById("nomePaciente").value,{x:1370.25,y:1361.5,size:28,font});

 /* ‚úÖ USO CORRIGIDO */
 const usoValor = document.getElementById("uso").value;
 if(usoValor){
  p.drawText(usoValor,{x:406.4,y:1150.64,size:28,font});
  p.drawText(usoValor,{x:1587.4,y:1150.64,size:28,font});
 }

 /* MEDICA√á√ïES */
 let y=1009.17;
 document.querySelectorAll(".medicacao-box").forEach((b,i)=>{
  const t=`${i+1}) ${b.querySelector(".med1").value}\n${b.querySelector(".med2").value}`;
  p.drawText(t,{x:157,y,size:28,font,lineHeight:30});
  p.drawText(t,{x:1339.33,y,size:28,font,lineHeight:30});
  y-=120;
 });

 /* DATA */
 const d = document.getElementById("dataDia").value;
 const m = document.getElementById("dataMes").value;
 const a = document.getElementById("dataAno").value;

 if(d && m && a){
  p.drawText(d,{x:878,y:171.83,size:28,font});
  p.drawText(m,{x:933.5,y:171.83,size:28,font});
  p.drawText(a,{x:990.5,y:171.83,size:28,font});

  p.drawText(d,{x:2060.5,y:171.83,size:28,font});
  p.drawText(m,{x:2117.5,y:171.83,size:28,font});
  p.drawText(a,{x:2172,y:171.83,size:28,font});
 }

 const bytes=await pdf.save();
 const blob=new Blob([bytes],{type:"application/pdf"});
 const aTag=document.createElement("a");
 aTag.href=URL.createObjectURL(blob);
// üî• NOME DO PACIENTE PARA O ARQUIVO
const nomePaciente = document
  .getElementById("nomePaciente")
  .value
  .trim() || "Paciente";

// Remove caracteres inv√°lidos para nome de arquivo
const nomeSeguro = nomePaciente.replace(/[\\\/:*?"<>|]/g, "");

aTag.download = `Receitu√°rio - ${nomeSeguro}.pdf`;
 aTag.click();
 URL.revokeObjectURL(aTag.href);
}
function limparDados(){
  if(!confirm("Deseja limpar todos os campos da receita?")) return;

  // Nome do paciente
  document.getElementById("nomePaciente").value = "";

  // Uso
  document.getElementById("uso").value = "";

  // Data
  document.getElementById("dataDia").value = "";
  document.getElementById("dataMes").value = "";
  document.getElementById("dataAno").value = "";

  // Medica√ß√µes
  document.getElementById("listaMedicacoes").innerHTML = "";

  // PDF base N√ÉO √© apagado
}
/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyAhWOQRO47_RiBjj2RG4BXf7lhYy6KNiDg",
  authDomain: "receituario-3c175.firebaseapp.com",
  projectId: "receituario-3c175",
  storageBucket: "receituario-3c175.firebasestorage.app",
  messagingSenderId: "809180223495",
  appId: "1:809180223495:web:b6004647b7a0c6965f32a2"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* LOGIN */
function login(){
  const email = document.getElementById("loginEmail").value;
  const senha = document.getElementById("loginSenha").value;

  auth.signInWithEmailAndPassword(email, senha)
    .catch(err => alert("Erro: " + err.message));
}

/* CONTROLE DE SESS√ÉO */
auth.onAuthStateChanged(user=>{
  const login = document.getElementById("loginBox");
  const app = document.getElementById("app");

  if(user){
    login.style.display = "none";
    app.style.display = "block";

    carregarMedicacoesFirebase(); // üî• AQUI
  }else{
    login.style.display = "block";
    app.style.display = "none";
  }
});

/* LOGOUT (opcional) */
function logout(){
  auth.signOut();
}
</script>

</body>
</html>









