<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Receita M√©dica</title>

<!-- üî• FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

<!-- PDF-LIB -->
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<style>
body{margin:0;font-family:Arial,sans-serif;background:#f4f4f4}

/* LOGIN */
#login{
 max-width:360px;margin:120px auto;background:#fff;
 padding:20px;border-radius:8px
}
#login h2{text-align:center}
#login input{width:100%;padding:10px;margin-bottom:10px}
#erro{color:red;text-align:center}

/* APP */
.container{max-width:750px;margin:auto;padding:16px;display:none}
h1{text-align:center;margin-bottom:20px}
.campo{margin-bottom:16px}
label{font-weight:bold;display:block;margin-bottom:6px}

input,select,textarea{
 width:100%;padding:12px;font-size:16px;box-sizing:border-box
}

button{
 padding:12px;font-size:16px;border:none;border-radius:6px;
 cursor:pointer;background:#27ae60;color:#fff
}

.sair{background:#e74c3c;margin-bottom:16px}
.btn-add{background:#2980b9}
.btn-lupa{background:#34495e}
.btn-apagar{background:#e74c3c}

.medicacao-box{background:#fff;border:1px solid #ccc;padding:10px;margin-bottom:10px}
.medicacao-linha{display:flex;gap:6px;align-items:center}
.num{width:32px;font-weight:bold;text-align:center}

/* SIDEBAR */
.sidebar{position:fixed;inset:0;background:#fff;display:none;flex-direction:column;z-index:999}
.sidebar-topo{background:#e74c3c;padding:6px 10px}
.sidebar-topo button{background:#c0392b}
.sidebar-busca{padding:8px}
.sidebar-lista{flex:1;overflow-y:auto;padding:8px}
.categoria{font-weight:bold;margin-top:10px}
.item{padding:6px;border-bottom:1px dashed #ccc;cursor:pointer}
.item:hover{background:#f0f0f0}
</style>
</head>

<body>

<!-- üîê LOGIN -->
<div id="login">
 <h2>Acesso restrito</h2>
 <input id="email" type="email" placeholder="Email">
 <input id="senha" type="password" placeholder="Senha">
 <button onclick="login()">Entrar</button>
 <p id="erro"></p>
</div>

<!-- üîì APP -->
<div class="container" id="app">

<h1>Receita M√©dica</h1>
<button class="sair" onclick="logout()">Sair</button>

<div class="campo">
<label>PDF base</label>
<div style="background:#e8f6ff;padding:10px;border-radius:6px">
üìÑ Receita padr√£o carregada automaticamente
</div>
</div>

<div class="campo">
<label>Nome do paciente</label>
<input id="nomePaciente" oninput="this.value=this.value.toUpperCase()">
</div>

<div class="campo">
<label>Uso</label>
<select id="uso">
<option value="">Selecione</option>
<option>USO ORAL</option>
<option>USO T√ìPICO</option>
</select>
</div>

<div class="campo">
<label>Medica√ß√µes</label>
<div id="listaMedicacoes"></div>
<button class="btn-add" onclick="adicionarMedicacao()">‚ûï Adicionar</button>
</div>

<div class="campo">
<label>Data</label>
<div style="display:flex;gap:6px">
<input id="dataDia" placeholder="DD" maxlength="2">
<input id="dataMes" placeholder="MM" maxlength="2">
<input id="dataAno" placeholder="AAAA" maxlength="4">
</div>
</div>

<button onclick="gerarPDF()">üìÑ Gerar PDF</button>
</div>

<!-- SIDEBAR -->
<div id="sidebar" class="sidebar">
 <div class="sidebar-topo">
  <button onclick="fecharSidebar()">Fechar</button>
 </div>
 <div class="sidebar-busca">
  <input placeholder="Buscar..." oninput="renderizarLista(this.value)">
 </div>
 <div id="listaSidebar" class="sidebar-lista"></div>
</div>

<script>
/* üî• FIREBASE CONFIG */
firebase.initializeApp({
 apiKey: "AIzaSyAhWOQRO47_RiBjj2RG4BXf7lhYy6KNiDg",
 authDomain: "receituario-3c175.firebaseapp.com",
 projectId: "receituario-3c175"
});

const auth = firebase.auth();

/* üîê LOGIN */
function login(){
 const email = document.getElementById("email").value.trim();
 const senha = document.getElementById("senha").value.trim();
 const erro  = document.getElementById("erro");

 erro.innerText = "";

 if(!email || !senha){
  erro.innerText = "Informe email e senha";
  return;
 }

 auth.signInWithEmailAndPassword(email, senha)
  .catch(() => erro.innerText = "Email ou senha inv√°lidos");
}

function logout(){
 auth.signOut();
}

/* CONTROLE DE ACESSO (BUG CORRIGIDO) */
auth.onAuthStateChanged(user=>{
 const loginDiv = document.getElementById("login");
 const appDiv   = document.getElementById("app");

 if(user){
  loginDiv.style.display = "none";
  appDiv.style.display   = "block";
 }else{
  loginDiv.style.display = "block";
  appDiv.style.display   = "none";
 }
});

/* ===== APP ===== */
const LIMITE = 8;
let campoAtual = null;

const banco = [
 {c:"üíä Exemplo", n:"Paracetamol 500mg", u:"Tomar 1 CP de 6/6h"}
];

function adicionarMedicacao(){
 if(document.querySelectorAll(".medicacao-box").length>=LIMITE)
  return alert("Limite m√°ximo de 8 medica√ß√µes");

 const d=document.createElement("div");
 d.className="medicacao-box";
 d.innerHTML=`
 <div class="medicacao-linha">
  <div class="num"></div>
  <input class="med1" placeholder="Medica√ß√£o">
  <button class="btn-lupa" onclick="abrirSidebar(this)">üîç</button>
  <button class="btn-apagar" onclick="this.closest('.medicacao-box').remove();numerar()">‚úñ</button>
 </div>
 <textarea class="med2" placeholder="Uso"></textarea>`;
 listaMedicacoes.appendChild(d);
 numerar();
}

function numerar(){
 document.querySelectorAll(".num").forEach((e,i)=>e.textContent=(i+1)+")");
}

function abrirSidebar(btn){
 campoAtual=btn.closest(".medicacao-box");
 sidebar.style.display="flex";
 renderizarLista();
}
function fecharSidebar(){sidebar.style.display="none";}

function renderizarLista(f=""){
 listaSidebar.innerHTML="";
 let cat="";
 banco.filter(m=>(m.n+m.u).toLowerCase().includes(f.toLowerCase()))
 .forEach(m=>{
  if(m.c!==cat){
   cat=m.c;
   const c=document.createElement("div");
   c.className="categoria";
   c.innerText=cat;
   listaSidebar.appendChild(c);
  }
  const i=document.createElement("div");
  i.className="item";
  i.innerHTML=`<strong>${m.n}</strong><br>${m.u}`;
  i.onclick=()=>{
   campoAtual.querySelector(".med1").value=m.n;
   campoAtual.querySelector(".med2").value=m.u;
   fecharSidebar();
  };
  listaSidebar.appendChild(i);
 });
}

/* üìÑ PDF BASE AUTOM√ÅTICO */
async function gerarPDF(){
 const response = await fetch("pdf/receita_base.pdf");
 if(!response.ok) return alert("PDF base n√£o encontrado");

 const pdf = await PDFLib.PDFDocument.load(await response.arrayBuffer());
 const font = await pdf.embedFont(PDFLib.StandardFonts.TimesRoman);
 const p = pdf.getPages()[0];

 p.drawText(nomePaciente.value,{x:188,y:1361,size:28,font});
 p.drawText(nomePaciente.value,{x:1370,y:1361,size:28,font});

 let y=1009;
 document.querySelectorAll(".medicacao-box").forEach((b,i)=>{
  const t=`${i+1}) ${b.querySelector(".med1").value}\n${b.querySelector(".med2").value}`;
  p.drawText(t,{x:157,y,size:28,font,lineHeight:30});
  y-=120;
 });

 const bytes=await pdf.save();
 const blob=new Blob([bytes],{type:"application/pdf"});
 const a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download="receita.pdf";
 a.click();
}
</script>

</body>
</html>
