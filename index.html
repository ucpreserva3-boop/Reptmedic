<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Preenchimento de Receita</title>

<!-- PDF-LIB -->
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<style>
body{margin:0;font-family:Arial,sans-serif;background:#f4f4f4}
.container{max-width:750px;margin:auto;padding:16px}
h1{text-align:center;margin-bottom:20px}
.campo{margin-bottom:16px}
label{font-weight:bold;display:block;margin-bottom:6px}

input,select,textarea{
  width:100%;
  padding:12px;
  font-size:16px;
  box-sizing:border-box
}

button{
  padding:12px;
  font-size:16px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  background:#27ae60;
  color:#fff;
}

.medicacao-box{background:#fff;border:1px solid #ccc;padding:10px;margin-bottom:10px}
.medicacao-linha{display:flex;gap:6px;align-items:center}
.num{width:32px;font-weight:bold;text-align:center}
.btn-apagar{background:#e74c3c}
.btn-lupa{background:#34495e}
.btn-add{background:#2980b9;margin-top:8px}

/* DATA */
.data-box{display:flex;gap:10px}
.data-box input{text-align:center}

/* SIDEBAR */
.sidebar{
  position:fixed;
  inset:0;
  background:#fff;
  z-index:999;
  display:none;
  flex-direction:column;
}

.sidebar-topo{
  background:#e74c3c;
  padding:6px 10px;
}
.sidebar-topo button{
  background:#c0392b;
  padding:6px 10px;
  font-size:14px;
}

.sidebar-busca{
  padding:8px;
}
.sidebar-busca input{
  padding:6px 8px;
  font-size:13px;
  height:32px;
}

.sidebar-lista{
  flex:1;
  overflow-y:auto;
  padding:6px 8px;
}

.categoria{
  font-weight:bold;
  margin:10px 0 4px;
  font-size:14px;
}

.item{
  padding:6px 4px;
  border-bottom:1px dashed #ccc;
  font-size:14px;
  line-height:1.3;
  cursor:pointer;
}
.item:hover{background:#f0f0f0}
</style>
</head>

<body>

<div class="container">
<h1>Receita M√©dica</h1>

<div class="campo">
<label>Selecionar PDF base</label>
<input type="file" id="pdfBase" accept="application/pdf">
</div>

<div class="campo">
<label>NOME DO PACIENTE</label>
<input id="nomePaciente" oninput="this.value=this.value.toUpperCase()">
</div>

<div class="campo">
<label>USO</label>
<select id="uso">
<option value="">Selecione</option>
<option>USO ORAL</option>
<option>USO T√ìPICO</option>
</select>
</div>

<div class="campo">
<label>MEDICA√á√ïES</label>
<div id="listaMedicacoes"></div>
<button type="button" class="btn-add" onclick="adicionarMedicacao()">‚ûï Adicionar Medica√ß√£o</button>
</div>

<div class="campo">
<label>DATA</label>
<div class="data-box">
<input id="dataDia" placeholder="DD" maxlength="2">
<input id="dataMes" placeholder="MM" maxlength="2">
<input id="dataAno" placeholder="AAAA" maxlength="4">
</div>
</div>

<button type="button" onclick="gerarPDF()">üìÑ Gerar PDF</button>
</div>

<!-- SIDEBAR -->
<div id="sidebar" class="sidebar">
  <div class="sidebar-topo">
    <button type="button" onclick="fecharSidebar()">Fechar</button>
  </div>
  <div class="sidebar-busca">
    <input placeholder="Buscar..." oninput="renderizarLista(this.value)">
  </div>
  <div id="listaSidebar" class="sidebar-lista"></div>
</div>

<script>
const LIMITE = 8;
let campoAtual = null;

/* Primeira letra mai√∫scula sem travar CAPS */
function cap(t){
 if(!t) return "";
 return t[0].toUpperCase() + t.slice(1);
}

/* BANCO DE MEDICA√á√ïES */
const banco=[
/* --- TODO O SEU BANCO ORIGINAL PERMANECE IGUAL --- */
{c:"üëßüèªParenta",n:"Topiramato 50mg - 60 CP",u:"Tomar 1 CP V.O pela manh√£ e 1 CP a noite"}  
];

/* üîπ ADICIONADO AUTOMATICAMENTE */
/* SALVAR MEDICA√á√ïES NOVAS */
function salvarMedicacoesNovas(){
 document.querySelectorAll(".medicacao-box").forEach(box=>{
  const nome = box.querySelector(".med1").value.trim();
  const uso  = box.querySelector(".med2").value.trim();

  if(!nome || !uso) return;

  const existe = banco.some(m =>
    m.n.toLowerCase() === nome.toLowerCase() &&
    m.u.toLowerCase() === uso.toLowerCase()
  );

  if(!existe){
    banco.push({
      c: "‚≠ê Medica√ß√µes rec√©m adicionadas",
      n: nome,
      u: uso
    });
  }
 });
}

/* MEDICA√á√ïES */
function adicionarMedicacao(){
 if(document.querySelectorAll(".medicacao-box").length>=LIMITE)
  return alert("Limite m√°ximo de 8 medica√ß√µes.");

 const d=document.createElement("div");
 d.className="medicacao-box";
 d.innerHTML=`
 <div class="medicacao-linha">
  <div class="num"></div>
  <input class="med1" placeholder="Medica√ß√£o" oninput="this.value=cap(this.value)">
  <button type="button" class="btn-lupa" onclick="abrirSidebar(this)">üîç</button>
  <button type="button" class="btn-apagar" onclick="this.closest('.medicacao-box').remove();numerar()">APAGAR</button>
 </div>
 <textarea class="med2" placeholder="Uso" oninput="this.value=cap(this.value)"></textarea>`;
 document.getElementById("listaMedicacoes").appendChild(d);
 numerar();
}

function numerar(){
 document.querySelectorAll(".num").forEach((e,i)=>e.textContent=(i+1)+")");
}

/* SIDEBAR */
function abrirSidebar(btn){
 campoAtual=btn.closest(".medicacao-box");
 document.getElementById("sidebar").style.display="flex";
 renderizarLista();
}
function fecharSidebar(){
 document.getElementById("sidebar").style.display="none";
}

function renderizarLista(f=""){
 const l=document.getElementById("listaSidebar");
 l.innerHTML="";
 let cat="";
 banco.filter(m=>(m.n+m.u).toLowerCase().includes(f.toLowerCase()))
 .forEach(m=>{
  if(m.c!==cat){
   cat=m.c;
   const c=document.createElement("div");
   c.className="categoria";
   c.textContent=m.c;
   l.appendChild(c);
  }
  const i=document.createElement("div");
  i.className="item";
  i.innerHTML=`<strong>${m.n}</strong><br>${m.u}`;
  i.onclick=()=>{
   campoAtual.querySelector(".med1").value=m.n;
   campoAtual.querySelector(".med2").value=m.u;
   fecharSidebar();
  };
  l.appendChild(i);
 });
}

/* GERAR PDF */
async function gerarPDF(){

 /* üîπ ADICIONADO AUTOMATICAMENTE */
 salvarMedicacoesNovas();

 const file=document.getElementById("pdfBase").files[0];
 if(!file) return alert("Selecione o PDF base.");

 const pdf=await PDFLib.PDFDocument.load(await file.arrayBuffer());
 const font=await pdf.embedFont(PDFLib.StandardFonts.TimesRoman);
 const p=pdf.getPages()[0];

 /* NOME */
 p.drawText(document.getElementById("nomePaciente").value,{x:188,y:1361.5,size:28,font});
 p.drawText(document.getElementById("nomePaciente").value,{x:1370.25,y:1361.5,size:28,font});

 /* USO */
 const usoValor = document.getElementById("uso").value;
 if(usoValor){
  p.drawText(usoValor,{x:406.4,y:1150.64,size:28,font});
  p.drawText(usoValor,{x:1587.4,y:1150.64,size:28,font});
 }

 /* MEDICA√á√ïES */
 let y=1009.17;
 document.querySelectorAll(".medicacao-box").forEach((b,i)=>{
  const t=`${i+1}) ${b.querySelector(".med1").value}\n${b.querySelector(".med2").value}`;
  p.drawText(t,{x:157,y,size:28,font,lineHeight:30});
  p.drawText(t,{x:1339.33,y,size:28,font,lineHeight:30});
  y-=120;
 });

 /* DATA */
 const d = document.getElementById("dataDia").value;
 const m = document.getElementById("dataMes").value;
 const a = document.getElementById("dataAno").value;

 if(d && m && a){
  p.drawText(d,{x:878,y:171.83,size:28,font});
  p.drawText(m,{x:933.5,y:171.83,size:28,font});
  p.drawText(a,{x:990.5,y:171.83,size:28,font});

  p.drawText(d,{x:2060.5,y:171.83,size:28,font});
  p.drawText(m,{x:2117.5,y:171.83,size:28,font});
  p.drawText(a,{x:2172,y:171.83,size:28,font});
 }

 const bytes=await pdf.save();
 const blob=new Blob([bytes],{type:"application/pdf"});
 const aTag=document.createElement("a");
 aTag.href=URL.createObjectURL(blob);
 aTag.download="receita.pdf";
 aTag.click();
 URL.revokeObjectURL(aTag.href);
}
</script>

</body>
</html>
