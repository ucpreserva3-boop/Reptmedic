<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Preenchimento de Receita</title>

<!-- üî• FIREBASE (COMPAT) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<!-- PDF-LIB -->
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<style>
body{margin:0;font-family:Arial,sans-serif;background:#f4f4f4}

/* LOGIN */
#loginBox{max-width:380px;margin:120px auto;background:#fff;padding:20px;border-radius:8px}
#loginBox h2{text-align:center;margin-bottom:16px}
#loginBox input{width:100%;padding:10px;margin-bottom:10px}
#erro{color:red;text-align:center}

/* APP */
.container{max-width:750px;margin:auto;padding:16px;display:none}
h1{text-align:center;margin-bottom:20px}
.campo{margin-bottom:16px}
label{font-weight:bold;display:block;margin-bottom:6px}

input,select,textarea{
 width:100%;padding:12px;font-size:16px;box-sizing:border-box
}

button{
 padding:12px;font-size:16px;border:none;border-radius:6px;
 cursor:pointer;background:#27ae60;color:#fff
}

.sair{background:#e74c3c;margin-bottom:16px}
.medicacao-box{background:#fff;border:1px solid #ccc;padding:10px;margin-bottom:10px}
.medicacao-linha{display:flex;gap:6px;align-items:center}
.num{width:32px;font-weight:bold;text-align:center}
.btn-apagar{background:#e74c3c}
.btn-lupa{background:#34495e}
.btn-add{background:#2980b9;margin-top:8px}

/* SIDEBAR */
.sidebar{position:fixed;inset:0;background:#fff;z-index:999;display:none;flex-direction:column}
.sidebar-topo{background:#e74c3c;padding:6px 10px}
.sidebar-topo button{background:#c0392b;font-size:14px}
.sidebar-busca{padding:8px}
.sidebar-lista{flex:1;overflow-y:auto;padding:8px}
.categoria{font-weight:bold;margin-top:10px}
.item{padding:6px;border-bottom:1px dashed #ccc}
.acoes-item{display:flex;gap:6px;margin-top:4px}
.acoes-item button{font-size:12px;padding:6px}
.btn-editar{background:#f1c40f;color:#000}
.btn-excluir{background:#e74c3c}
</style>
</head>

<body>

<!-- üîê LOGIN -->
<div id="loginBox">
<h2>Acesso restrito</h2>
<input id="email" placeholder="Email">
<input id="senha" type="password" placeholder="Senha">
<button onclick="fazerLogin()">Entrar</button>
<p id="erro"></p>
</div>

<!-- üîì APP -->
<div class="container" id="app">
<h1>Receita M√©dica</h1>
<button class="sair" onclick="logout()">Sair</button>

<div class="campo">
<label>PDF base</label>
<input type="file" id="pdfBase">
</div>

<div class="campo">
<label>Paciente</label>
<input id="nomePaciente">
</div>

<div class="campo">
<label>Medica√ß√µes</label>
<div id="listaMedicacoes"></div>
<button class="btn-add" onclick="adicionarMedicacao()">‚ûï Adicionar</button>
</div>

<button onclick="gerarPDF()">Gerar PDF</button>
</div>

<!-- SIDEBAR -->
<div id="sidebar" class="sidebar">
 <div class="sidebar-topo">
  <button onclick="fecharSidebar()">Fechar</button>
 </div>
 <div class="sidebar-busca">
  <input placeholder="Buscar..." oninput="renderizarLista(this.value)">
 </div>
 <div id="listaSidebar" class="sidebar-lista"></div>
</div>

<script>
firebase.initializeApp({
 apiKey: "AIzaSyAhWOQRO47_RiBjj2RG4BXf7lhYy6KNiDg",
 authDomain: "receituario-3c175.firebaseapp.com",
 projectId: "receituario-3c175"
});

const auth=firebase.auth();
const db=firebase.firestore();

function fazerLogin(){
 erro.innerText="";
 auth.signInWithEmailAndPassword(email.value,senha.value)
 .catch(e=>erro.innerText=e.message);
}

function logout(){auth.signOut();}

auth.onAuthStateChanged(u=>{
 loginBox.style.display=u?"none":"block";
 app.style.display=u?"block":"none";
 if(u) carregarMedicacoes();
});

let banco=[],campoAtual=null;

async function carregarMedicacoes(){
 const s=await db.collection("medicacoes").get();
 banco=s.docs.map(d=>d.data());
}

function adicionarMedicacao(){
 const d=document.createElement("div");
 d.className="medicacao-box";
 d.innerHTML=`
 <div class="medicacao-linha">
  <div class="num"></div>
  <input class="med1">
  <button class="btn-lupa" onclick="abrirSidebar(this)">üîç</button>
 </div>
 <textarea class="med2"></textarea>`;
 listaMedicacoes.appendChild(d);
}

function abrirSidebar(btn){
 campoAtual=btn.closest(".medicacao-box");
 sidebar.style.display="flex";
 renderizarLista();
}

function fecharSidebar(){sidebar.style.display="none";}

function renderizarLista(f=""){
 listaSidebar.innerHTML="";
 let cat="";
 banco.filter(m=>(m.nome+m.uso).toLowerCase().includes(f.toLowerCase()))
 .forEach(m=>{
  if(m.categoria!==cat){
   cat=m.categoria;
   listaSidebar.innerHTML+=`<div class="categoria">${cat}</div>`;
  }
  const i=document.createElement("div");
  i.className="item";
  i.innerHTML=`
   <strong>${m.nome}</strong><br>${m.uso}
   <div class="acoes-item">
    <button class="btn-editar" onclick="editarItem('${m.categoria}','${m.nome}','${m.uso}')">Editar</button>
    <button class="btn-excluir" onclick="apagarItem('${m.nome}','${m.uso}')">Apagar</button>
   </div>`;
  i.onclick=()=>{
   campoAtual.querySelector(".med1").value=m.nome;
   campoAtual.querySelector(".med2").value=m.uso;
   fecharSidebar();
  };
  listaSidebar.appendChild(i);
 });
}

function editarItem(c,n,u){
 alert("Editar: "+n);
}

async function apagarItem(n,u){
 if(!confirm("Apagar?"))return;
 const q=await db.collection("medicacoes").where("nome","==",n).where("uso","==",u).get();
 q.forEach(d=>d.ref.delete());
 await carregarMedicacoes();
 renderizarLista();
}

async function gerarPDF(){
 alert("PDF gerado (exemplo)");
}
</script>

</body>
</html>
