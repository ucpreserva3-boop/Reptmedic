<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Automatizador de Receita</title>

<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<style>
body { margin:0; font-family:Arial,sans-serif; background:#f4f4f4; }
.container { padding:20px; }

.topo { position:relative; margin-bottom:30px; }
.titulo { font-size:24px; font-weight:bold; }

.area-pdf {
  position:absolute;
  left:50%;
  top:0;
  transform:translateX(-50%);
  text-align:center;
}
.btn-pdf {
  background:#e74c3c;
  color:#fff;
  padding:8px 16px;
  border-radius:4px;
  cursor:pointer;
}
.pdf-status {
  margin-top:8px;
  font-size:13px;
  color:green;
  display:none;
}

.campo { margin-bottom:15px; }
label { font-weight:bold; display:block; margin-bottom:4px; }
input, select, textarea {
  width:100%;
  padding:8px;
  box-sizing:border-box;
}

/* DATA */
.data-box {
  display:flex;
  gap:10px;
  max-width:260px;
}
.data-box input { text-align:center; }
.data-dd { width:60px; }
.data-mm { width:60px; }
.data-aaaa { width:80px; }

/* MEDICA√á√ïES */
.medicacao-box {
  border:1px solid #ccc;
  background:#fff;
  padding:10px;
  margin-bottom:10px;
}
.medicacao-linha {
  display:flex;
  gap:5px;
  align-items:center;
}
.num {
  width:30px;
  border:1px solid #4a67ff;
  color:#4a67ff;
  text-align:center;
  font-weight:bold;
}
.btn-lupa { background:#000; color:#fff; border:none; padding:6px; cursor:pointer; }
.btn-apagar { background:#ff3b3b; color:#fff; border:none; padding:6px 10px; cursor:pointer; }
.btn-add { background:#2e86de; color:#fff; border:none; padding:8px 14px; cursor:pointer; }

/* SIDEBAR */
.sidebar {
  position:fixed;
  right:-420px;
  top:0;
  width:420px;
  height:100%;
  background:#fff;
  border-left:2px solid #ccc;
  padding:15px;
  overflow-y:auto;
  transition:right .3s;
  z-index:999;
}
.sidebar.open { right:0; }
.sidebar .close {
  background:red;
  color:#fff;
  border:none;
  cursor:pointer;
  float:right;
}

.categoria { font-weight:bold; margin-top:12px; }
.medicacao-item {
  padding:6px;
  border-bottom:1px dashed #ccc;
  cursor:pointer;
}
.medicacao-item:hover { background:#f0f0f0; }

.add-manual {
  border-top:2px solid #ccc;
  margin-top:15px;
  padding-top:10px;
}
</style>
</head>

<body>

<div class="container">

  <div class="topo">
    <div class="titulo">Preenchimento de Receita</div>
    <div class="area-pdf">
      <label class="btn-pdf">
        Selecionar PDF
        <input type="file" id="pdfBase" accept="application/pdf" hidden>
      </label>
      <div id="pdfStatus" class="pdf-status">(PDF selecionado)</div>
    </div>
  </div>

  <div class="campo">
    <label>NOME DO PACIENTE</label>
    <input id="nomePaciente">
  </div>

  <div class="campo">
    <label>USO</label>
    <select id="uso">
      <option value="">Selecione</option>
      <option>USO ORAL</option>
      <option>USO T√ìPICO</option>
    </select>
  </div>

  <div class="campo">
    <label>MEDICA√á√ïES</label>
    <div id="listaMedicacoes"></div>
    <button class="btn-add" onclick="adicionarMedicacao()">‚ûï Adicionar Medica√ß√£o</button>
  </div>

  <div class="campo">
    <label>DATA</label>
    <div class="data-box">
      <input id="dataDia" class="data-dd" placeholder="DD" maxlength="2">
      <input id="dataMes" class="data-mm" placeholder="MM" maxlength="2">
      <input id="dataAno" class="data-aaaa" placeholder="AAAA" maxlength="4">
    </div>
  </div>

  <button onclick="gerarPDF()">Gerar Receita</button>
</div>

<!-- SIDEBAR -->
<div id="sidebar" class="sidebar">
  <button class="close" onclick="fecharSidebar()">X</button>
  <h3>Buscar medica√ß√£o</h3>
  <input placeholder="Buscar..." oninput="renderizarLista(this.value)">
  <div id="listaSidebar"></div>

  <div class="add-manual">
    <strong>‚ûï Adicionar medica√ß√£o</strong>
    <input id="manualNome" placeholder="Nome da medica√ß√£o">
    <textarea id="manualUso" placeholder="Como tomar"></textarea>
    <button onclick="salvarManual()">Salvar</button>
  </div>
</div>

<script>
/* ================= BANCO ================= */
let bancoMedicacoes = [
  { cat:"‚ù§Ô∏è Hipertens√£o / Cardiovascular", nome:"Hidroclorotiazida 25mg", uso:"Tomar 1 CP cedo e 1 CP √† noite" },
  { cat:"‚ù§Ô∏è Hipertens√£o / Cardiovascular", nome:"Losartana Pot√°ssica 50mg", uso:"Tomar 1 CP cedo e 1 CP √† noite" },
  { cat:"‚ù§Ô∏è Hipertens√£o / Cardiovascular", nome:"Losartana Pot√°ssica 30mg", uso:"Tomar 1 CP 12/12h" },
  { cat:"‚ù§Ô∏è Hipertens√£o / Cardiovascular", nome:"Carvedilol 6,25mg", uso:"Tomar 1 CP VO 12/12h" },
  { cat:"‚ù§Ô∏è Hipertens√£o / Cardiovascular", nome:"Furosemida 40mg", uso:"Tomar MEIO CP ao dia" },
  { cat:"‚ù§Ô∏è Hipertens√£o / Cardiovascular", nome:"Espironolactona 25mg", uso:"Tomar 1 CP cedo" },
  { cat:"‚ù§Ô∏è Hipertens√£o / Cardiovascular", nome:"Espironolactona 25mg", uso:"Tomar 1 CP pela manh√£ e 1 CP √† noite" },
  { cat:"‚ù§Ô∏è Hipertens√£o / Cardiovascular", nome:"Digoxina 0,25mg", uso:"Tomar MEIO CP ao dia" },
  { cat:"‚ù§Ô∏è Hipertens√£o / Cardiovascular", nome:"AAS 100mg", uso:"Tomar 1 CP ap√≥s o almo√ßo" },
  { cat:"‚ù§Ô∏è Hipertens√£o / Cardiovascular", nome:"Sinvastatina 20mg", uso:"Tomar MEIO CP ao dia" },
  { cat:"‚ù§Ô∏è Hipertens√£o / Cardiovascular", nome:"Sinvastatina 20mg", uso:"Tomar 1 CP ao dia" },
  { cat:"ü´Å Asma / Doen√ßas respirat√≥rias", nome:"Aerolin Spray", uso:"Aspirar 2 jatos de 8/8h se falta de ar (m√°x. 8 jatos/dia)" },
  { cat:"ü´Å Asma / Doen√ßas respirat√≥rias", nome:"Clenil HFA 250", uso:"Aspirar 1 jato de 12/12h" },
  { cat:"ü´Å Asma / Doen√ßas respirat√≥rias", nome:"Xarope de Guaco", uso:"Tomar 10 ml de 8/8h" },
  { cat:"ü§ß Antial√©rgicos", nome:"Dexclorfeniramina 2mg", uso:"Tomar 1 CP de 8/8h" },
  { cat:"ü§ß Antial√©rgicos", nome:"Dexclorfeniramina", uso:"Tomar 10 ml de 8/8h" },
  { cat:"ü§ß Antial√©rgicos", nome:"Dexclorfeniramina", uso:"Tomar 5 ml VO de 8/8h" },
  { cat:"üíä Dor / Febre / Analg√©sicos / Anti-inflamat√≥rios", nome:"Dipirona", uso:"Tomar 40 gotas de 6/6h" },
  { cat:"üíä Dor / Febre / Analg√©sicos / Anti-inflamat√≥rios", nome:"Dipirona", uso:"Tomar 30 gotas de 6/6h se dor ou febre" },
  { cat:"üíä Dor / Febre / Analg√©sicos / Anti-inflamat√≥rios", nome:"Paracetamol 500mg", uso:"Tomar 1 CP VO de 6/6h" },
  { cat:"üíä Dor / Febre / Analg√©sicos / Anti-inflamat√≥rios", nome:"Ibuprofeno 600mg", uso:"Tomar 1 CP VO de 8/8h" },
  { cat:"ü¶† Antibi√≥ticos (uso sist√™mico)", nome:"Amoxicilina 500mg", uso:"Tomar 2 CP de 8/8h" },
  { cat:"ü¶† Antibi√≥ticos (uso sist√™mico)", nome:"Amoxicilina + Clavulanato 500 + 125mg", uso:"Tomar 1 CP de 8/8h por 7 dias" },
  { cat:"ü¶† Antibi√≥ticos (uso sist√™mico)", nome:"Azitromicina 500mg", uso:"Tomar 1 CP ao dia por 5 dias" },
  { cat:"ü¶† Antibi√≥ticos (uso sist√™mico)", nome:"Sulfametoxazol + Trimetoprima 400/80mg", uso:"Tomar 2 CP √†s segundas, quartas e sextas" },
  { cat:"ü¶† Antibi√≥ticos (uso sist√™mico)", nome:"Sulfametoxazol + Trimetoprima 200mg + 40mg", uso:"Tomar 10 ml de 12/12h por 10 dias" },
  { cat:"ü¶† Antibi√≥ticos (uso sist√™mico)", nome:"Nitrofuranto√≠na 100mg", uso:"Tomar 1 CP ao dia" },
  { cat:"ü¶† Antibi√≥ticos (uso sist√™mico)", nome:"Nitrofuranto√≠na 100mg", uso:"Tomar 1 CP ao dia" },
  { cat:"ü¶† Antif√∫ngicos / Ginecol√≥gicos", nome:"Miconazol 20mg pomada", uso:"Aplicar 3 vezes ao dia nas les√µes" },
  { cat:"ü¶† Antif√∫ngicos / Ginecol√≥gicos", nome:"Nistatina creme vaginal 25.000 UI/g", uso:"Aplicar 1 dose vaginal √† noite por 14 dias" },
  { cat:"ü¶† Antif√∫ngicos / Ginecol√≥gicos", nome:"Nistatina suspens√£o 100.000 UI/ml", uso:"Tomar VO 3 vezes ao dia por 7 dias" },
  { cat:"ü¶† Antif√∫ngicos / Ginecol√≥gicos", nome:"Tinidazol + Nitrato de Miconazol", uso:"Aplicar 1 vez √† noite antes de dormir por 7 dias" },
  { cat:"üß¥ Pomadas / Uso t√≥pico dermatol√≥gico", nome:"Bacitracina + Neomicina", uso:"Aplicar 3 vezes ao dia" },
  { cat:"üß¥ Pomadas / Uso t√≥pico dermatol√≥gico", nome:"Creme de Pr√≥polis", uso:"Aplicar 3 vezes ao dia" },
  { cat:"üß¥ Pomadas / Uso t√≥pico dermatol√≥gico", nome:"Vitamina A + Vitamina D + √ìxido de Zinco", uso:"Aplicar a cada troca de fralda" },
  { cat:"üß¥ Pomadas / Uso t√≥pico dermatol√≥gico", nome:"Rifasan Spray 10mg/ml", uso:"Pulverizar a √°rea afetada a cada 8 horas" },
  { cat:"üß† Neurol√≥gicos / Psiqui√°tricos", nome:"Amitriptilina 25mg", uso:"Tomar 1 CP VO √† noite" },
  { cat:"üß† Neurol√≥gicos / Psiqui√°tricos", nome:"Citalopram 20mg", uso:"Tomar 2 CP ao dia" },
  { cat:"üß† Neurol√≥gicos / Psiqui√°tricos", nome:"Pregabalina 50mg", uso:"Tomar 2 CP VO de 12/12h" },
  { cat:"üß¨ End√≥crinos / Metab√≥licos", nome:"Levotiroxina 50mg", uso:"Tomar 1 CP cedo em jejum" },
  { cat:"üß¨ End√≥crinos / Metab√≥licos", nome:"Glifage XR 500mg", uso:"Tomar 1 CP VO ap√≥s almo√ßo e 1 ap√≥s jantar" },
  { cat:"üçΩÔ∏è Gastrointestinais", nome:"Omeprazol 20mg", uso:"Tomar 1 CP cedo em jejum" },
  { cat:"üçΩÔ∏è Gastrointestinais", nome:"Bromoprida", uso:"Tomar 40 gotas de 8/8h se n√°useas ou v√¥mitos" },
  { cat:"üõ°Ô∏è Corticoides", nome:"Prednisona 20mg", uso:"Tomar 1 CP VO 1x ao dia por 30 dias" },
  { cat:"üõ°Ô∏è Corticoides", nome:"Prednisona 20mg", uso:"Tomar 3 CP cedo" },
  { cat:"üõ°Ô∏è Corticoides", nome:"Dexametasona 4mg", uso:"Tomar 5 CP no caf√© da manh√£ e 5 no almo√ßo" },
  { cat:"ü©∏ Hematol√≥gicos / Vasculares", nome:"Sulfato Ferroso 40mg", uso:"Tomar 1 CP VO antes do almo√ßo" },
  { cat:"ü©∏ Hematol√≥gicos / Vasculares", nome:"Diosmina + Hesperidina 450mg + 50mg", uso:"Tomar 1 CP de 12/12h por 3 meses" },
  { cat:"üíä Vitaminas", nome:"Complexo B 30mg", uso:"Tomar 1 CP ao dia" },
];

let campoAtual = null;
const LIMITE = 7;

function normalizar(t) {
  return t.toLowerCase().replace(/\s+/g," ").trim();
}
function capitalizarPrimeira(str) {
  if (!str) return "";
  return str.charAt(0).toUpperCase() + str.slice(1);
}

document.getElementById("pdfBase").addEventListener("change", () => {
  document.getElementById("pdfStatus").style.display = "block";
});

/* ===== NUMERA√á√ÉO ===== */
function atualizarNumeracao() {
  document.querySelectorAll(".medicacao-box .num").forEach((el, i) => {
    el.textContent = (i + 1) + ")";
  });
}

/* ===== MEDICA√á√ïES ===== */
function adicionarMedicacao() {
  if (document.querySelectorAll(".medicacao-box").length >= LIMITE) {
    return alert("Limite de 7 medica√ß√µes.");
  }

  const div = document.createElement("div");
  div.className = "medicacao-box";
  div.innerHTML = `
    <div class="medicacao-linha">
      <div class="num"></div>
      <input class="med1" oninput="this.value=capitalizarPrimeira(this.value)">
      <button class="btn-lupa" onclick="abrirSidebar(this)">üîç</button>
      <button class="btn-apagar" onclick="removerMedicacao(this)">Apagar</button>
    </div>
    <textarea class="med2" oninput="this.value=capitalizarPrimeira(this.value)"></textarea>
  `;
  document.getElementById("listaMedicacoes").appendChild(div);
  atualizarNumeracao();
}

function removerMedicacao(btn) {
  btn.closest(".medicacao-box").remove();
  atualizarNumeracao();
}

/* ===== SIDEBAR ===== */
function abrirSidebar(btn) {
  campoAtual = btn.closest(".medicacao-box");
  document.getElementById("sidebar").classList.add("open");
  renderizarLista();
}
function fecharSidebar() {
  document.getElementById("sidebar").classList.remove("open");
}

function renderizarLista(filtro="") {
  const lista = document.getElementById("listaSidebar");
  lista.innerHTML = "";
  let catAtual = "";

  bancoMedicacoes
    .filter(m => normalizar(m.nome+m.uso).includes(normalizar(filtro)))
    .forEach(m => {
      if (m.cat !== catAtual) {
        catAtual = m.cat;
        const c = document.createElement("div");
        c.className = "categoria";
        c.textContent = m.cat;
        lista.appendChild(c);
      }
      const d = document.createElement("div");
      d.className = "medicacao-item";
      d.innerHTML = `<strong>${m.nome}</strong><br>${m.uso}`;
      d.onclick = () => {
        campoAtual.querySelector(".med1").value = m.nome;
        campoAtual.querySelector(".med2").value = m.uso;
        fecharSidebar();
      };
      lista.appendChild(d);
    });
}

/* ===== SALVAR MEDICA√á√ïES NOVAS (ADI√á√ÉO) ===== */
function salvarMedicacoesNovasNoBanco() {
  document.querySelectorAll(".medicacao-box").forEach(box => {
    const nome = capitalizarPrimeira(box.querySelector(".med1").value);
    const uso  = capitalizarPrimeira(box.querySelector(".med2").value);
    if (!nome || !uso) return;

    if (!bancoMedicacoes.some(m =>
      normalizar(m.nome) === normalizar(nome) &&
      normalizar(m.uso) === normalizar(uso)
    )) {
      bancoMedicacoes.push({
        cat: "Medica√ß√µes rec√©m adicionadas",
        nome,
        uso
      });
    }
  });
}

/* ===== PDF ===== */
async function gerarPDF() {
  const file = document.getElementById("pdfBase").files[0];
  if (!file) return alert("Selecione o PDF base.");

  salvarMedicacoesNovasNoBanco();   // ‚Üê ADI√á√ÉO
  renderizarLista();               // ‚Üê atualiza sidebar

  const pdfBytes = await file.arrayBuffer();
  const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
  const font = await pdfDoc.embedFont(PDFLib.StandardFonts.TimesRoman);
  const page = pdfDoc.getPages()[0];

  const nome = document.getElementById("nomePaciente").value.toUpperCase();
  page.drawText(nome, { x:188, y:1361.5, size:28, font });
  page.drawText(nome, { x:1370.25, y:1362.09, size:28, font });

  const uso = document.getElementById("uso").value;
  if (uso) {
    page.drawText(uso, { x:406.40, y:1150.64, size:25, font });
    page.drawText(uso, { x:1587.40, y:1151.44, size:25, font });
  }

  let yE = 1009.17;
  let yD = 1008.83;
  document.querySelectorAll(".medicacao-box").forEach((box,i) => {
    const texto = `${i+1}) ${box.querySelector(".med1").value}\n${box.querySelector(".med2").value}`;
    page.drawText(texto, { x:157, y:yE, size:25, font, lineHeight:30 });
    page.drawText(texto, { x:1339.33, y:yD, size:25, font, lineHeight:30 });
    yE -= 120; yD -= 120;
  });

  const d = document.getElementById("dataDia").value;
  const m = document.getElementById("dataMes").value;
  const a = document.getElementById("dataAno").value;

  if (d && m && a) {
    page.drawText(d, { x:878.00, y:171.83, size:25, font });
    page.drawText(m, { x:933.50, y:171.83, size:25, font });
    page.drawText(a, { x:990.50, y:171.83, size:25, font });

    page.drawText(d, { x:2060.50, y:171.83, size:25, font });
    page.drawText(m, { x:2117.50, y:171.83, size:25, font });
    page.drawText(a, { x:2172.00, y:171.83, size:25, font });
  }

  const pdfFinal = await pdfDoc.save();
  const blob = new Blob([pdfFinal], { type:"application/pdf" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "receita_preenchida.pdf";
  link.click();
}
  <script>
function salvarManual() {
  const nome = document.getElementById("manualNome").value;
  const uso  = document.getElementById("manualUso").value;

  if (!nome || !uso) {
    alert("Preencha nome e modo de uso.");
    return;
  }

  bancoMedicacoes.push({
    cat: "Medica√ß√µes adicionadas manualmente",
    nome: capitalizarPrimeira(nome),
    uso: capitalizarPrimeira(uso)
  });

  document.getElementById("manualNome").value = "";
  document.getElementById("manualUso").value = "";

  renderizarLista();
  alert("Medica√ß√£o salva com sucesso!");
}
</script>

</body>
</html>

