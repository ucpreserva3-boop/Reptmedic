<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Receita M√©dica</title>

<!-- üî• Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<!-- PDF-LIB -->
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<style>
body{margin:0;font-family:Arial,sans-serif;background:#f4f4f4}
#login{max-width:360px;margin:120px auto;background:#fff;padding:20px;border-radius:8px}
#login input{width:100%;padding:10px;margin-bottom:10px}
#erro{color:red;text-align:center}
.container{max-width:750px;margin:auto;padding:16px;display:none}
button{padding:12px;border:none;border-radius:6px;cursor:pointer}
.sair{background:#e74c3c;color:#fff}
.btn-add{background:#2980b9;color:#fff}
.btn-lupa{background:#34495e;color:#fff}
.btn-apagar{background:#e74c3c;color:#fff}
.gerar{background:#27ae60;color:#fff}
.medicacao-box{background:#fff;padding:10px;margin-bottom:10px;border:1px solid #ccc}
.medicacao-linha{display:flex;gap:6px;align-items:center}
.num{width:32px;text-align:center;font-weight:bold}
.sidebar{position:fixed;inset:0;background:#fff;display:none;flex-direction:column;z-index:999}
.sidebar-topo{background:#e74c3c;padding:8px}
.sidebar-topo button{background:#c0392b;color:#fff}
.sidebar-lista{flex:1;overflow-y:auto;padding:8px}
.categoria{font-weight:bold;margin-top:10px}
.item{padding:6px;border-bottom:1px dashed #ccc;cursor:pointer}
.item:hover{background:#f0f0f0}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="login">
<h2>Acesso restrito</h2>
<input id="email" type="email" placeholder="Email">
<input id="senha" type="password" placeholder="Senha">
<button id="btnLogin">Entrar</button>
<p id="erro"></p>
</div>

<!-- APP -->
<div class="container" id="app">
<h1>Receita M√©dica</h1>
<button class="sair" onclick="logout()">Sair</button>

<input id="nomePaciente" placeholder="Nome do paciente">
<select id="uso">
<option>USO ORAL</option>
<option>USO T√ìPICO</option>
</select>

<div id="listaMedicacoes"></div>
<button class="btn-add" onclick="adicionarMedicacao()">‚ûï Adicionar</button>

<button class="gerar" onclick="gerarPDF()">üìÑ Gerar PDF</button>
</div>

<!-- SIDEBAR -->
<div id="sidebar" class="sidebar">
 <div class="sidebar-topo">
  <button onclick="fecharSidebar()">Fechar</button>
 </div>
 <div id="listaSidebar" class="sidebar-lista"></div>
</div>

<script>
// üî• FIREBASE
firebase.initializeApp({
 apiKey: "AIzaSyAhWOQRO47_RiBjj2RG4BXf7lhYy6KNiDg",
 authDomain: "receituario-3c175.firebaseapp.com",
 projectId: "receituario-3c175"
});
const auth = firebase.auth();
const db = firebase.firestore();

// LOGIN
document.getElementById("btnLogin").onclick = () => {
 const email = document.getElementById("email").value.trim();
 const senha = document.getElementById("senha").value.trim();
 const erro  = document.getElementById("erro");
 erro.innerText="";
 auth.signInWithEmailAndPassword(email,senha)
  .catch(()=>erro.innerText="Email ou senha inv√°lidos");
};

function logout(){auth.signOut();}

// üîë CONTROLE DE TELA (CORRIGIDO)
auth.onAuthStateChanged(user=>{
 const loginDiv=document.getElementById("login");
 const appDiv=document.getElementById("app");

 if(user){
  loginDiv.style.display="none";
  appDiv.style.display="block";
  carregarMedicacoes();
 }else{
  loginDiv.style.display="block";
  appDiv.style.display="none";
 }
});

// MEDICA√á√ïES
let banco=[];
let campoAtual=null;

function adicionarMedicacao(){
 const d=document.createElement("div");
 d.className="medicacao-box";
 d.innerHTML=`
 <div class="medicacao-linha">
  <div class="num"></div>
  <input class="med1">
  <button class="btn-lupa" onclick="abrirSidebar(this)">üîç</button>
  <button class="btn-apagar" onclick="this.parentElement.parentElement.remove()">‚úñ</button>
 </div>
 <textarea class="med2"></textarea>`;
 document.getElementById("listaMedicacoes").appendChild(d);
}

function abrirSidebar(btn){
 campoAtual=btn.closest(".medicacao-box");
 document.getElementById("sidebar").style.display="flex";
 renderizarLista();
}
function fecharSidebar(){
 document.getElementById("sidebar").style.display="none";
}

// FIRESTORE
async function carregarMedicacoes(){
 const snap=await db.collection("medicacoes").get();
 banco=snap.docs.map(d=>d.data());
}

function renderizarLista(){
 const lista=document.getElementById("listaSidebar");
 lista.innerHTML="";
 banco.forEach(m=>{
  const i=document.createElement("div");
  i.className="item";
  i.innerHTML=`<strong>${m.nome}</strong><br>${m.uso}`;
  i.onclick=()=>{
   campoAtual.querySelector(".med1").value=m.nome;
   campoAtual.querySelector(".med2").value=m.uso;
   fecharSidebar();
  };
  lista.appendChild(i);
 });
}

async function salvarMedicacoes(){
 const boxes=document.querySelectorAll(".medicacao-box");
 for(const b of boxes){
  const nome=b.querySelector(".med1").value.trim();
  const uso=b.querySelector(".med2").value.trim();
  if(!nome||!uso) continue;

  const q=await db.collection("medicacoes")
   .where("nome","==",nome).where("uso","==",uso).get();
  if(q.empty){
   await db.collection("medicacoes").add({nome,uso});
  }
 }
}

// PDF BASE AUTOM√ÅTICO
async function gerarPDF(){
 await salvarMedicacoes();

 const res=await fetch("pdf/receita_base.pdf");
 const pdf=await PDFLib.PDFDocument.load(await res.arrayBuffer());
 const font=await pdf.embedFont(PDFLib.StandardFonts.TimesRoman);
 const p=pdf.getPages()[0];

 p.drawText(nomePaciente.value,{x:200,y:1300,size:24,font});

 const bytes=await pdf.save();
 const blob=new Blob([bytes],{type:"application/pdf"});
 const a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download="receita.pdf";
 a.click();
}
</script>
</body>
</html>
